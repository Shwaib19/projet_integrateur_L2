{% extends "base/layout.html" %}
{% load static%}

<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}proprietes{% endblock title %}</title>
    {% block css %}
    <link rel="stylesheet" href="{% static "css/bien/style.css" %}" >
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    {% endblock css %}
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js"
            }
        }
    </script>
</head>
<body>
    {% block content %}
    <div class="container">
        <header>
            <h1>Détails de la Propriété</h1>
        </header>

        <main class="property-page">
            <section class="image-carousel">
                <div class="carousel-container">
                    <div class="image-grid">
                        <div class="main-image">
                            <img src="{{images.first.image.url}}" alt="Image principale de la propriété" id="main-property-image">
                        </div>
                        <div class="thumbnail-container">
                            
                            {% if images|length > 0 %}
                            <img src="{{images.first.image.url}}" alt="Image 1 de la propriété" class="thumbnail active" data-index="0">
                          {% endif %}
                          {% if images|length > 1 %}
                            <img src="{{ images.1.image.url }}" alt="Image 2 de la propriété" class="thumbnail" data-index="1">
                          {% endif %}
                          {% if images|length > 2 %}
                          <img src="{{ images.2.image.url }}" alt="Image 3 de la propriété" class="thumbnail" data-index="2">
                          {% endif %}
                          {% if images|length > 3 %}
                          <img src="{{ images.3.image.url }}" alt="Image 4 de la propriété" class="thumbnail" data-index="3">
                          {% endif %}
                          {% if images|length > 4 %}
                          <img src="{{ images.4.image.url }}" alt="Image 5 de la propriété" class="thumbnail" data-index="4">
                          {% endif %}
                        </div>
                    </div>
                </div>
            </section>

            <section class="property-actions">
            {% if user.is_authenticated%}
                {% if user.user_type == "CLIENT" %}
                    <button onclick="toggleFavori({{ propriete.id }})"  class="action-button like-button">
                        
                        {%  if est_favori %}
                        <i class="fas fa-heart-broken"></i>Retirer des favoris</button>                      
                        {%  else %}
                         <i class="fas fa-heart"></i> Liker</button>
                        {%  endif %}

                    <a href="{% url "prendre_rendez_vous" propriete.id  %}"> 
                        <button  class="action-button like-button"><i class="fas fa-calendar-alt"></i> Prendrerendez-vous</button>
                    </a>
                {% endif %}
                {% if user.user_type == "AGENT" or user.user_type == "MANAGER"  or user.user_type == "BAILLEUR" %}
                <a href="{% url "modifier_propriete" propriete.pk %}">    
                <button class="action-button edit-button"><i class="fas fa-edit"></i> Modifier</button>
                </a>
                {% endif %}
            
            {% else%}
            <a href="{% url "login"%}">
                <button  class="action-button like-button"><i class="fas fa-heart"></i> Liker</button>
            </a>

            <a href="{% url "login"%}">
                <button  class="action-button like-button"><i class="fas fa-calendar-alt"></i> Prendrerendez-vous</button>
            </a>

            {% endif %}
            </section>


            <section class="property-details">
                <h2>Belle Maison en Centre-Ville</h2>
                <h3> Statut: {{propriete.statut}} </h3>
                {% if propriete.option == "location" %}
                <p class="price">Prix: {{propriete.prix}} fcfa /mois</p>
                {%else%}
                <p class="price">Prix: {{propriete.prix}} fcfa</p>
                {% endif %}
                <p class="location">{{propriete.localisation}}</p>
                <div class="description">
                    <h3>Option : {{propriete.type}}</h3>
                    <h3>Type d'offre : {{propriete.option}}</h3>
                    <p>
                        {{propriete.usage}}
                    </p>
                </div>
                <div class="features">
                    <h3>Caractéristiques</h3>
                    <div class="features-grid">
                        <div class="feature-item">
                            <i class="fas fa-ruler-combined"></i>
                            <span>Surface: {{propriete.superficie}} m²</span>
                        </div>
                        
                        </div>
                    </div>
                </div>
            </section>

            
        </main>
        
        <footer>
            <p>&copy; 2025 Hava</p>
        </footer>
        
    </div>


        <script>
        function toggleFavori(proprieteId) {
            fetch(`../favoris/toggle/${proprieteId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Accept': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message); // Affiche le message (à remplacer par une alerte stylée si tu veux)
                    location.reload();
                } else if (data.error) {
                    alert('Erreur : ' + data.error);
                }
            })
            .catch(error => {
                alert('Erreur réseau : ' + error);
            });
        }

        // Fonction pour récupérer le token CSRF depuis les cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Cherche le cookie correspondant au nom
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        </script>


    {% endblock content %}
    
    {% block js_import%}<script src="{% static "js/bien/script.js" %}"></script>{% endblock js_import%}
    
</body>
</html>